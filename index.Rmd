---
title: "福岡県における新型コロナウイルス感染症の動向"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
# ライブラリ
library(tidyr)
library(dplyr)
library(readr)
library(lubridate)
library(RcppRoll)
library(flexdashboard)
library(plotly)

# 関数
last_value <- function(dat, col){
  col <- enquo(col)
  dat %>% select(!!col) %>% tail(1) %>% pull()
}
md <- function(x){
  str_c(month(x), "/", day(x))
}

# データ
population <- read_csv("data/population.csv")
newlycases <- read_csv("data/newlycases.csv")
patients   <- read_csv("data/patients.csv")
inspection <- read_csv("data/inspection.csv")
situation  <- read_csv("data/situation.csv")
sickbeds   <- read_csv("data/sickbeds.csv")

# 定数
pref_pop <- population %>% filter(name == "県") %>% pull()
```

ステージ判断指標
=====================================  

Row
-----------------------------------------------------------------------
### 新規感染者数
```{r}
detected <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7),
         increase = detected_sum > lag(detected_sum),
         value = detected_sum / pref_pop * 1e5) %>% 
  filter(date >= "2021-01-01") %>% 
  select(date, value, increase)
detected_value <- detected %>% last_value(value)
detected_increase <- detected %>% last_value(increase)
valueBox(sprintf("%.1f", detected_value), 
         caption = "直近1週間の10万人あたり新規感染者数（人）",
         icon = ifelse(detected_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(detected_value >= 25, "danger", 
                        ifelse(detected_value >= 15, "warning", "primary"))
         )
```

### 感染経路不明割合
```{r}
untraceable <- patients %>% 
  group_by(date, untraceable) %>% summarise(n = n()) %>% ungroup() %>% 
  mutate(untraceable = if_else(is.na(untraceable), "traceable", "untraceable")) %>% 
  pivot_wider(names_from = untraceable, values_from = n, values_fill = 0) %>% 
  complete(date = full_seq(date, 1), fill = list(untraceable = 0, traceable = 0)) %>% 
  mutate(n = untraceable + traceable, sum_n = roll_sumr(n, 7),
         sum_u = roll_sumr(untraceable, 7), value = sum_u / sum_n * 100,
         increase = value > lag(value)) %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
untraceable_value <- untraceable %>% last_value(value)
untraceable_increase <- untraceable %>% last_value(increase)
valueBox(sprintf("%.1f", untraceable_value), 
         caption = "感染経路不明割合（％）",
         icon = ifelse(untraceable_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(untraceable_value >= 50, "danger", "primary"))
```

### 検査等陽性率
```{r}
positive_ratio <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7)) %>% left_join(inspection) %>% 
  mutate(inspected_sum = roll_sumr(inspected, 7),
         value = detected_sum / inspected_sum * 100,
         increase = value > lag(value)) %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
positive_ratio_value <- positive_ratio %>% last_value(value)
positive_ratio_increase <- positive_ratio %>% last_value(increase)
valueBox(sprintf("%.2f", positive_ratio_value), 
         caption = "検査等陽性率（％）",
         icon = ifelse(positive_ratio_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(positive_ratio_value >= 10, "danger", 
                        ifelse(positive_ratio_value >= 5, "warning", "primary"))
         )
```

Row
-----------------------------------------------------------------------

### Chart B

```{r}

```

### Chart C

```{r}

```

