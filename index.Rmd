---
title: "Fukuoka COVID-19 Dashboard"
author: "@kzktmr"
output: 
  flexdashboard::flex_dashboard:
    social: [ "menu" ]
    source_code: "https://github.com/kzktmr/Covid19Dashboard"
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
# ライブラリ
library(tidyr)
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(RcppRoll)
library(ggplot2)
library(flexdashboard)
library(plotly)

# 関数
last_value <- function(dat, col){
  col <- enquo(col)
  dat %>% select(!!col) %>% tail(1) %>% pull()
}
md <- function(x){
  str_c(month(x), "/", day(x))
}

# データ
population  <- read_csv("data/population.csv")
newlycases  <- read_csv("data/newlycases.csv")
patients    <- read_csv("data/patients.csv")
inspection  <- read_csv("data/inspection.csv")
situation   <- read_csv("data/situation.csv")
sickbeds    <- read_csv("data/sickbeds.csv")
vaccination <- read_csv("data/vaccination.csv")
age_pop     <- read_csv("data/population_by_age.csv")

# 定数
pref_pop <- population %>% filter(name == "県") %>% pull()
age_pop2 <- tibble(age = c("-64", "65-"), pop = c(3046999, 1396860))
```

ステージ判断指標
=====================================  

Row
-----------------------------------------------------------------------

### 新規感染者数
```{r}
detected <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7),
         increase = detected_sum > lag(detected_sum),
         value = detected_sum / pref_pop * 1e5) %>% 
  filter(date >= "2021-01-01") %>% 
  select(date, value, increase)
detected_value <- detected %>% last_value(value)
detected_increase <- detected %>% last_value(increase)
valueBox(sprintf("%.1f", detected_value), 
         caption = "直近1週間の10万人あたり新規感染者数（人）",
         icon = ifelse(detected_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(detected_value >= 25, "danger", 
                        ifelse(detected_value >= 15, "warning", "primary"))
         )
```

### 感染経路不明割合
```{r}
untraceable <- patients %>% 
  group_by(date, untraceable) %>% summarise(n = n()) %>% ungroup() %>% 
  mutate(untraceable = if_else(is.na(untraceable), "traceable", "untraceable")) %>% 
  pivot_wider(names_from = untraceable, values_from = n, values_fill = 0) %>% 
  complete(date = full_seq(date, 1), fill = list(untraceable = 0, traceable = 0)) %>% 
  mutate(n = untraceable + traceable, sum_n = roll_sumr(n, 7),
         sum_u = roll_sumr(untraceable, 7), value = sum_u / sum_n * 100,
         increase = value > lag(value)) %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
untraceable_value <- untraceable %>% last_value(value)
untraceable_increase <- untraceable %>% last_value(increase)
valueBox(sprintf("%.1f", untraceable_value), 
         caption = "感染経路不明割合（％）",
         icon = ifelse(untraceable_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(untraceable_value >= 50, "danger", "primary"))
```

### 検査等陽性率
```{r}
positive_ratio <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7)) %>% left_join(inspection) %>% 
  mutate(inspected_sum = roll_sumr(inspected, 7),
         value = detected_sum / inspected_sum * 100,
         increase = value > lag(value)) %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
positive_ratio_value <- positive_ratio %>% last_value(value)
positive_ratio_increase <- positive_ratio %>% last_value(increase)
valueBox(sprintf("%.2f", positive_ratio_value), 
         caption = "検査等陽性率（％）",
         icon = ifelse(positive_ratio_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(positive_ratio_value >= 10, "danger", 
                        ifelse(positive_ratio_value >= 5, "warning", "primary"))
         )
```

Row
-----------------------------------------------------------------------

### 療養者数
```{r}
total_patient <-
  situation %>% filter(str_detect(name, "者の数$")) %>% 
  group_by(date) %>% summarise(value = sum(value)) %>% ungroup() %>% 
  mutate(increase = value > lag(value),
         value = value / pref_pop * 1e5) %>% drop_na() %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
total_patient_value <- total_patient %>% last_value(value)
total_patient_increase <- total_patient %>% last_value(increase)
valueBox(sprintf("%.1f", total_patient_value), 
         caption = "10万人あたり療養者数（人）",
         icon = ifelse(total_patient_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(total_patient_value >= 30, "danger", 
                        ifelse(total_patient_value >= 20, "warning", "primary"))
         )
```

### 確保病床使用率
```{r}
bed_occupancy <- situation %>% 
  filter(name == "うち確保病床の入院者数") %>% 
  filter(date >= "2021-01-01") %>% left_join(sickbeds) %>% na.omit() %>% 
  mutate(value = value / bed * 100, increase = value > lag(value))
bed_occupancy_value = bed_occupancy %>% last_value(value)
bed_occupancy_increase = bed_occupancy %>% last_value(increase)
valueBox(sprintf("%.1f", bed_occupancy_value), 
         caption = "確保病床使用率（％）",
         icon = ifelse(bed_occupancy_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(bed_occupancy_value >= 50, "danger", 
                        ifelse(bed_occupancy_value >= 20, "warning", "primary"))
         )
```

### 入院率
```{r}
hospital_ratio <- situation %>% 
  filter(str_detect(name, "者の数$")) %>% 
  pivot_wider() %>% 
  mutate(value = `入院中の者の数` / (`入院中の者の数` + `宿泊療養中の者の数` + `自宅待機等の者の数`) * 100,
         increase = value > lag(value)) %>% 
  filter(date >= "2021-01-01") %>% na.omit()
hospital_ratio_value <- hospital_ratio %>% last_value(value)
hospital_ratio_increase <- hospital_ratio %>% last_value(increase)
valueBox(sprintf("%.1f", hospital_ratio_value), 
         caption = "入院率（％）",
         icon = ifelse(hospital_ratio_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(hospital_ratio_value <= 25, "danger", 
                        ifelse(hospital_ratio_value <= 40, "warning", "primary"))
         )
```

Row
-----------------------------------------------------------------------

### 直近1週間の10万人あたり新規感染者数（人）

```{r}
detected_plot <- detected %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 25, color = "red", alpha = 0.5) +
  geom_hline(yintercept = 15, color = "orange", alpha = 0.5) +
  geom_path(color = "darkblue") + theme_light() + ylim(0, NA) +
  scale_x_date(labels = md, breaks = "1 month") +
  theme(axis.title = element_blank())
ggplotly(detected_plot)
```

### 感染経路不明割合（％）

```{r}
untraceable_plot <- untraceable %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 50, color = "red", alpha = 0.5) +
  geom_path(color = "darkblue") + theme_light() + 
  scale_x_date(labels = md, breaks = "1 month") +
  theme(axis.title = element_blank())
ggplotly(untraceable_plot)
```

### 検査等陽性率（％）

```{r}
positive_ratio_plot <- positive_ratio %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 10, color = "red", alpha = 0.5) +
  geom_hline(yintercept = 5, color = "orange", alpha = 0.5) +
  geom_path(color = "darkblue") + theme_light() + 
  scale_x_date(labels = md, breaks = "1 month") +
  theme(axis.title = element_blank())
ggplotly(positive_ratio_plot)
```

Row
-----------------------------------------------------------------------

### 10万人あたり療養者数

```{r}
total_patient_plot <- total_patient %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 30, color = "red", alpha = 0.5) +
  geom_hline(yintercept = 20, color = "orange", alpha = 0.5) +
  geom_path(color = "darkblue") + theme_light() + ylim(0, NA) +
  scale_x_date(labels = md, breaks = "1 month") +
  theme(axis.title = element_blank())
ggplotly(total_patient_plot)
```

### 確保病床使用率（％）
```{r}
bed_occupancy_plot <- bed_occupancy %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 50, color = "red", alpha = 0.5) +
  geom_hline(yintercept = 20, color = "orange", alpha = 0.5) +
  geom_path(color = "darkblue") + theme_light() + #ylim(0, NA) +
  scale_x_date(labels = md, breaks = "1 month") +
  theme(axis.title = element_blank())
ggplotly(bed_occupancy_plot)
```

### 入院率（％）
```{r}
hospital_ratio_plot <- hospital_ratio %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 40, color = "orange", alpha = 0.5) +
  geom_hline(yintercept = 25, color = "red", alpha = 0.5) +
  geom_path(color = "darkblue") + theme_light() + #ylim(0, NA) +
  scale_x_date(labels = md, breaks = "1 month") +
  theme(axis.title = element_blank())
ggplotly(hospital_ratio_plot)
```

ワクチン接種状況
=====================================  

```{r include=FALSE}
vaccination_rate <- 
  vaccination %>% filter(age != "UNK") %>% 
  group_by(date, age, status) %>% 
  summarise(count = sum(count), .groups = "keep") %>% 
  ungroup(date) %>% 
  mutate(cum_sum = cumsum(count)) %>% 
  left_join(age_pop2) %>% 
  mutate(ratio =  cum_sum/ pop * 100) %>% ungroup() %>% 
  mutate(date = as.Date(date), 
         age = factor(age, labels = c("65歳未満", "65歳以上")),
         status = factor(status, labels = c("1回目", "2回目"))) %>% 
  unite("status", age:status) %>% 
  arrange(date) 
```

Row
-----------------------------------------------------------------------

### 接種率（65歳未満，1回目）
```{r}
under65_1st <- vaccination_rate %>% 
  filter(status == "65歳未満_1回目") %>% last_value(ratio)
gauge(sprintf("%.1f", under65_1st), min = 0, max = 100, symbol = '%')
```

### 接種率（65歳未満，2回目）
```{r}
under65_2nd <- vaccination_rate %>% 
  filter(status == "65歳未満_2回目") %>% last_value(ratio)
gauge(sprintf("%.1f", under65_2nd), min = 0, max = 100, symbol = '%')
```

### 接種率（65歳以上，1回目）
```{r}
over65_1st <- vaccination_rate %>% 
  filter(status == "65歳以上_1回目") %>% last_value(ratio)
gauge(sprintf("%.1f", over65_1st), min = 0, max = 100, symbol = '%')
```

### 接種率（65歳以上，2回目）
```{r}
over65_2nd <- vaccination_rate %>% 
  filter(status == "65歳以上_2回目") %>% last_value(ratio)
gauge(sprintf("%.1f", over65_2nd), min = 0, max = 100, symbol = '%')
```

Row
-------------------------
### 接種回数の推移
```{r}
vaccination_plot <- vaccination %>% 
  group_by(date, age, status) %>% summarise(count = sum(count)) %>% ungroup() %>% 
  mutate(date = as.Date(date), 
         age = factor(age, labels = c("65歳未満", "65歳以上", "年齢不明")),
         status = factor(status, labels = c("1回目", "2回目"))) %>% 
  unite("status", age:status) %>% 
  ggplot(aes(x = date, y = count)) +
  geom_col(aes(fill = status)) +
  scale_x_date(labels = md) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(vaccination_plot) %>% layout(legend = list(x = 0, y = 1))
```

### 接種率の推移（％）
```{r}
vaccination_rate_plot <- vaccination_rate %>% 
  ggplot(aes(x = date, y = ratio, color = status)) +
  geom_line() +
  scale_x_date(labels = md) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_brewer(palette = "Set2") +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(vaccination_rate_plot) %>% layout(legend = list(x = 0, y = 1))
```

その他の指標①
=====================================  

Rows
-------------------------------------

### 新規陽性者数（人）
```{r}
positive_plot <- newlycases %>%
  select(date, value = detected) %>% 
  mutate(ma = roll_meanr(value, 7)) %>% 
  filter(date >= as.Date("2021-01-01")) %>%
  ggplot(aes(x = date, y = value)) +
  geom_col(fill = "lightblue", width = 1) +
  geom_line(aes(y = ma), color = "darkblue", linetype = "dotted") +
  scale_x_date(labels = md, breaks = "1 month") +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(positive_plot)
```

### PCR等検査件数（件）
```{r}
inspection_plot <- inspection %>% 
  select(date, value = inspected) %>% 
  mutate(ma = roll_meanr(value, 7)) %>% 
  filter(date >= "2021-01-01") %>% 
  ggplot(aes(x = date, y = value)) + 
  geom_col(fill = "lightblue", width = 1) +
  geom_line(aes(y = ma), color = "darkblue", linetype = "dotted") +
  scale_x_date(labels = md, breaks = "1 month") +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(inspection_plot)
```

Rows
-------------------------------------

### 新規感染者数の先週今週比
```{r}
weel_ratio_plot <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7),
         value = detected_sum / lag(detected_sum, 7)) %>% 
  select(date, value) %>% 
  filter(date >= as.Date("2021-01-01")) %>% 
  ggplot(aes(x = date, y = value)) +
  geom_hline(yintercept = 1, size = 0.25) +
  geom_line(color = "darkblue") +
  scale_x_date(labels = md, breaks = "1 month") +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(weel_ratio_plot)
```

### 新規感染者の若者割合（％）
```{r}
young_rate_plot <- patients %>% 
  filter(age != "調査中", age != "-") %>% 
  group_by(date, age) %>% summarise(n = n()) %>% ungroup() %>% 
  pivot_wider(names_from = age, values_from = n, values_fill = 0) %>% 
  rowwise() %>% mutate(合計 = sum(c_across(-date))) %>% 
  complete(date = full_seq(date, 1)) %>% 
  mutate(across(-date, replace_na, 0)) %>% 
  mutate(across(-date, roll_sumr, n = 7)) %>% 
  mutate(value = (`20代` + `30代`) / 合計 * 100) %>% 
  select(date, value) %>% filter(date >= "2021-01-01") %>% 
  # pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value)) + geom_line(color = "darkblue") +
  scale_x_date(labels = md, breaks = "1 month") +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(young_rate_plot)
```

その他の指標②
=====================================  

Rows {.tabset}
-------------------------------------

### 状況別感染者数（人）
```{r}
situation_plot <- situation %>% 
  filter(str_detect(name, "の者の数$")) %>% 
  mutate(name = str_remove(name, "の者の数$"),
         name = factor(name, levels = c("自宅待機等", "宿泊療養中", "入院中"))) %>% 
  select(date, name, value) %>% 
  filter(date >= "2021-01-01") %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_area() +
  scale_x_date(labels = md, breaks = "1 month") +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(palette = "Pastel1", direction = -1) +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(situation_plot) %>% layout(legend = list(x = 0, y = 1))
```

### 年代別10万人あたり新規感染者数（人）
```{r}
age_percapita_plot <- patients %>% 
  filter(age != "調査中", age != "-") %>% 
  group_by(date, age) %>% summarise(n = n()) %>% ungroup() %>% 
  pivot_wider(names_from = age, values_from = n, values_fill = 0) %>% 
  complete(date = full_seq(date, 1)) %>%
  mutate(across(-date, replace_na, 0)) %>% 
  mutate(across(-date, roll_sumr, n = 7)) %>% 
  filter(date >= "2021-01-01") %>% pivot_longer(-date) %>% 
  left_join(age_pop, by = c("name" = "age10")) %>% 
  mutate(age = factor(name, levels = c("10歳未満", str_c(seq(10, 80, 10), "代"), "90代以上"), labels = str_c(seq(0, 90, 10), "~", c(seq(9, 89, 10), "")))) %>% 
  mutate(value = value * 1e5 / population) %>% arrange(date, age) %>% 
  ggplot(aes(x = date, y = value, color = age)) + 
  geom_hline(yintercept = 25, color = "red", linetype = "dotted") +
  geom_hline(yintercept = 15, color = "orange", linetype = "dotted") +
  geom_line() +
  scale_x_date(labels = md, breaks = "1 month") +
  scale_color_brewer(palette = "Paired") +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.title = element_blank())
ggplotly(age_percapita_plot) %>% layout(legend = list(x = 0, y = 1))
```