---
title: "福岡県における新型コロナウイルス感染症の動向"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
# ライブラリ
library(tidyr)
library(dplyr)
library(readr)
library(lubridate)
library(RcppRoll)
library(flexdashboard)
library(plotly)

# 関数
last_value <- function(dat, col){
  col <- enquo(col)
  dat %>% select(!!col) %>% tail(1) %>% pull()
}
md <- function(x){
  str_c(month(x), "/", day(x))
}

# データ
population <- read_csv("data/population.csv")
newlycases <- read_csv("data/newlycases.csv")
patients   <- read_csv("data/patients.csv")
inspection <- read_csv("data/inspection.csv")
situation  <- read_csv("data/situation.csv")
sickbeds   <- read_csv("data/sickbeds.csv")

# 定数
pref_pop <- population %>% filter(name == "県") %>% pull()
```

ステージ判断指標
=====================================  

Row
-----------------------------------------------------------------------

### 新規感染者数
```{r}
detected <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7),
         increase = detected_sum > lag(detected_sum),
         value = detected_sum / pref_pop * 1e5) %>% 
  filter(date >= "2021-01-01") %>% 
  select(date, value, increase)
detected_value <- detected %>% last_value(value)
detected_increase <- detected %>% last_value(increase)
valueBox(sprintf("%.1f", detected_value), 
         caption = "直近1週間の10万人あたり新規感染者数（人）",
         icon = ifelse(detected_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(detected_value >= 25, "danger", 
                        ifelse(detected_value >= 15, "warning", "primary"))
         )
```

### 感染経路不明割合
```{r}
untraceable <- patients %>% 
  group_by(date, untraceable) %>% summarise(n = n()) %>% ungroup() %>% 
  mutate(untraceable = if_else(is.na(untraceable), "traceable", "untraceable")) %>% 
  pivot_wider(names_from = untraceable, values_from = n, values_fill = 0) %>% 
  complete(date = full_seq(date, 1), fill = list(untraceable = 0, traceable = 0)) %>% 
  mutate(n = untraceable + traceable, sum_n = roll_sumr(n, 7),
         sum_u = roll_sumr(untraceable, 7), value = sum_u / sum_n * 100,
         increase = value > lag(value)) %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
untraceable_value <- untraceable %>% last_value(value)
untraceable_increase <- untraceable %>% last_value(increase)
valueBox(sprintf("%.1f", untraceable_value), 
         caption = "感染経路不明割合（％）",
         icon = ifelse(untraceable_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(untraceable_value >= 50, "danger", "primary"))
```

### 検査等陽性率
```{r}
positive_ratio <- newlycases %>% 
  mutate(detected_sum = roll_sumr(detected, 7)) %>% left_join(inspection) %>% 
  mutate(inspected_sum = roll_sumr(inspected, 7),
         value = detected_sum / inspected_sum * 100,
         increase = value > lag(value)) %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
positive_ratio_value <- positive_ratio %>% last_value(value)
positive_ratio_increase <- positive_ratio %>% last_value(increase)
valueBox(sprintf("%.2f", positive_ratio_value), 
         caption = "検査等陽性率（％）",
         icon = ifelse(positive_ratio_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(positive_ratio_value >= 10, "danger", 
                        ifelse(positive_ratio_value >= 5, "warning", "primary"))
         )
```

Row
-----------------------------------------------------------------------

### 療養者数
```{r}
total_patient <-
  situation %>% filter(str_detect(name, "者の数$")) %>% 
  group_by(date) %>% summarise(value = sum(value)) %>% ungroup() %>% 
  mutate(increase = value > lag(value),
         value = value / pref_pop * 1e5) %>% drop_na() %>% 
  select(date, value, increase) %>% filter(date >= "2021-01-01")
total_patient_value <- total_patient %>% last_value(value)
total_patient_increase <- total_patient %>% last_value(increase)
valueBox(sprintf("%.1f", total_patient_value), 
         caption = "10万人あたり療養者数（人）",
         icon = ifelse(total_patient_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(total_patient_value >= 30, "danger", 
                        ifelse(total_patient_value >= 20, "warning", "primary"))
         )
```

### 確保病床使用率
```{r}
bed_occupancy <- situation %>% 
  filter(name == "うち確保病床の入院者数") %>% 
  filter(date >= "2021-01-01") %>% left_join(sickbeds) %>% na.omit() %>% 
  mutate(value = value / bed * 100, increase = value > lag(value))
bed_occupancy_value = bed_occupancy %>% last_value(value)
bed_occupancy_increase = bed_occupancy %>% last_value(increase)
valueBox(sprintf("%.1f", bed_occupancy_value), 
         caption = "確保病床使用率（％）",
         icon = ifelse(bed_occupancy_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(bed_occupancy_value >= 50, "danger", 
                        ifelse(bed_occupancy_value >= 20, "warning", "primary"))
         )
```

### 入院率
```{r}
hospital_ratio <- situation %>% 
  filter(str_detect(name, "者の数$")) %>% 
  pivot_wider() %>% 
  mutate(value = `入院中の者の数` / (`入院中の者の数` + `宿泊療養中の者の数` + `自宅待機等の者の数`) * 100,
         increase = value > lag(value)) %>% 
  filter(date >= "2021-01-01") %>% na.omit()
hospital_ratio_value <- hospital_ratio %>% last_value(value)
hospital_ratio_increase <- hospital_ratio %>% last_value(increase)
valueBox(sprintf("%.1f", hospital_ratio_value), 
         caption = "入院率（％）",
         icon = ifelse(hospital_ratio_increase, "fa-arrow-up", "fa-arrow-down"),
         color = ifelse(hospital_ratio_value <= 25, "danger", 
                        ifelse(hospital_ratio_value <= 40, "warning", "primary"))
         )
```

